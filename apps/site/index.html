<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ninvax</title>
    <link rel="stylesheet" href="assets/css/cyberpunk.css" />
    <style>
      body {
        background-color: #000000;
        color: #ff00ff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .intro-banner {
        animation: slideDown 1s ease-out;
        background-color: #ff00ff;
        color: #000;
        text-align: center;
        padding: 10px;
        font-size: 1.5em;
        font-family: "Orbitron", sans-serif;
        font-weight: bold;
      }
      main {
        max-width: 800px;
        margin: 0 auto;
      }
      .header {
        background-color: #000000;
        padding: 10px;
        text-align: center;
        border-bottom: 2px solid #800080;
        animation: pulse 3s infinite;
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .nav {
        margin-top: 10px;
      }
      .nav a {
        color: #ff00ff;
        margin: 0 10px;
        text-decoration: none;
        outline-offset: 2px;
      }
      .nav a:focus {
        outline: 2px solid #fff;
      }
      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 5px #800080;
        }
        50% {
          box-shadow: 0 0 15px #ff00ff;
        }
      }
      .search-bar {
        padding: 10px;
        margin: 10px;
        width: 80%;
        border-radius: 5px;
        border: 1px solid #800080;
        background-color: #000000;
        color: #ff00ff;
        position: sticky;

        top: var(--header-height);

        top: calc(
          var(--header-height) + 10px
        ); /* Dynamically position the search bar */

        z-index: 999;
      }
      .strain-list {
        padding: 10px;
      }
      .strain-card {
        background-color: #000000;
        border: 2px solid #800080;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
        color: #ffffff;
        outline-offset: 2px;
      }
      .strain-card:focus {
        outline: 2px solid #ff00ff;
      }
      .star {
        cursor: pointer;
        color: #ffd700;
        margin-left: 5px;
      }
      .order-btn {
        background-color: #ff00ff;
        color: #000000;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        outline-offset: 2px;
      }
      .order-btn:focus {
        outline: 2px solid #fff;
      }
      .store-form {
        padding: 10px;
        border: 2px solid #800080;
        margin: 20px;
      }
      .store-form input {
        width: calc(100% - 22px);
        padding: 10px;
        margin: 5px 0;
        background-color: #000000;
        border: 1px solid #800080;
        color: #ff00ff;
        border-radius: 5px;
      }
      .error {
        color: #ff4d4d;
        font-size: 0.9em;
        display: none;
        margin: 4px 0;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #4caf50;
        color: #fff;
        padding: 10px 20px;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .toast.show {
        opacity: 1;
      }
      .submit-btn {
        background-color: #ff00ff;
        color: #000000;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        outline-offset: 2px;
      }
      .submit-btn:focus {
        outline: 2px solid #fff;
      }
      .error {
        color: red;
        font-size: 0.9em;
        margin-top: 4px;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4caf50;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }
      footer {
        text-align: center;
        padding: 10px;
        color: #800080;
      }
      .ai-credit {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
      }
      .openai-logo {
        width: 32px;
        height: 32px;
        vertical-align: middle;
        animation: spin 6s linear infinite;
      }
      .chatgpt-badge {
        background: #fff;
        color: #000;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.9em;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      @keyframes slideDown {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="intro-banner">Ninvax ü™ê Reality Hackers Unite</div>
      <div id="nav-placeholder"></div>
    <main>
      <section style="text-align:center; margin-bottom:20px;">
        <h1>Ninvax Empire</h1>
        <p>The glitchy hub for reality hackers building a trillion‚Äëdollar empire.</p>
      </section>
      <input
        type="text"
        class="search-bar"
        placeholder="Search strains..."
        aria-label="Search strains"
        id="searchInput"
        onkeyup="filterStrains()"
      />
      <div class="strain-list" id="strainList"></div>

      <form id="storeForm" class="store-form" style="display:none;">
        <input type="text" id="name" placeholder="Strain name" required />
        <input
          type="number"
          id="price"
          placeholder="Price"
          step="0.01"
          required
        />
        <div id="priceError" class="error"></div>
        <input type="text" id="store" placeholder="Store name" required />
        <button type="submit" class="submit-btn">Add Strain</button>
      </form>
    </main>

    <script>
      function debounce(func, delay) {
          let timeoutId;
          return function(...args) {
              clearTimeout(timeoutId);
              timeoutId = setTimeout(() => func.apply(this, args), delay);
          };
      }
      let strains = [];

      let favorites = JSON.parse(localStorage.getItem('starredStrains') || '[]');
      let showingFavorites = false;

      async function loadStrains() {
          const cached = localStorage.getItem('strainsData');
          const timestamp = localStorage.getItem('strainsTimestamp');
          const now = Date.now();
          if (cached && timestamp && now - parseInt(timestamp, 10) < 24 * 60 * 60 * 1000) {
              strains = JSON.parse(cached);
              renderStrains();
              return;
          }
          try {
              const res = await fetch('/products');
              if (res.ok) {
                  strains = await res.json();
                  localStorage.setItem('strainsData', JSON.stringify(strains));
                  localStorage.setItem('strainsTimestamp', now.toString());
              }
          } catch (e) {
              console.error('Failed to fetch strains', e);
          }
          renderStrains();
      }

      function renderStrains(data = strains) {
          const list = document.getElementById('strainList');
          list.innerHTML = '';
          if (!data.length) {
              list.textContent = 'No results found';
              return;
          }
          data.forEach((strain) => {
              const card = document.createElement('div');
              card.className = 'strain-card';

              const starred = favorites.includes(strain.name) ? '‚òÖ' : '‚òÜ';
              card.innerHTML = `<h3>${strain.name} <span class="star" onclick="toggleFavorite('${strain.name}')">${starred}</span></h3><p>$${strain.price.toFixed(2)} at ${strain.store}</p>`;
              card.tabIndex = 0;
              list.appendChild(card);
          });
      }

      async function toggleFavorite(name) {
          const userRes = await fetch('/current_user');
          const user = userRes.ok ? await userRes.json() : null;
          if (!user) {
              alert('Login to save favorites');
              return;
          }
          const idx = favorites.indexOf(name);
          if (idx > -1) {
              favorites.splice(idx, 1);
          } else {
              favorites.push(name);
          }
          localStorage.setItem('starredStrains', JSON.stringify(favorites));
          if (showingFavorites) {
              renderStrains(strains.filter(s => favorites.includes(s.name)));
          } else {
              renderStrains();
          }
      }

      function filterStrains() {
          const input = document.getElementById('searchInput').value.toLowerCase();
          const base = showingFavorites ? strains.filter(s => favorites.includes(s.name)) : strains;
          const filtered = base.filter(s => s.name.toLowerCase().includes(input));
          renderStrains(filtered);
      }


      document.getElementById('price').addEventListener('input', function() {
          this.value = this.value.match(/^\d*\.?\d*$/) ? this.value : this.value.slice(0, -1);
      });

      const priceInput = document.getElementById('price');
      priceInput.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9.]/g, '');
      });

      function showToast(message, isError = false) {
          const toast = document.getElementById('toast');

          if (!toast) {
              console.warn('Toast element not found in the DOM.');
              return;
          }

          toast.textContent = message;
          toast.style.backgroundColor = isError ? '#c0392b' : '#4caf50';
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
      }


      document.getElementById('storeForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const name = document.getElementById('name').value.trim();

          const priceInput = document.getElementById('price');
          const price = parseFloat(priceInput.value);
          const store = document.getElementById('store').value.trim();
          const priceError = document.getElementById('priceError');
          const isInvalidPrice = isNaN(price) || price <= 0;
          if (!name || !store || isInvalidPrice) {
              if (isInvalidPrice) {
                  priceError.textContent = 'Price must be > 0';
              }
              showToast('Failed to add strain', true);
              return;
          }
          priceError.textContent = '';

          const errorEl = document.getElementById('priceError');
          if (isNaN(price) || price <= 0) {
              errorEl.style.display = 'block';
              showToast('Price must be > 0', true);
              return;
          }
          errorEl.style.display = 'none';


          const res = await fetch('/strains', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, price, store })
          });
          if (res.ok) {
              loadStrains();
              this.reset();
              showToast('Strain added!');
          } else {
              showToast('Failed to add strain', true);
          }
      });

      document.getElementById('favoritesTab').addEventListener('click', function(e) {
          e.preventDefault();
          showingFavorites = true;
          renderStrains(strains.filter(s => favorites.includes(s.name)));
      });

      document.getElementById('homeTab').addEventListener('click', function(e) {
          e.preventDefault();
          showingFavorites = false;
          renderStrains();
      });

      window.onload = async function() {
          loadStrains();
          setInterval(loadStrains, 24 * 60 * 60 * 1000);
          const searchInput = document.getElementById('searchInput');
          const debouncedFilter = debounce(filterStrains, 300);
          searchInput.addEventListener('input', debouncedFilter);

          const res = await fetch('/current_user');
          if (res.ok && await res.json()) {
              document.getElementById('storeForm').style.display = 'block';
          }
      };
    </script>
      <script src="assets/js/nav.js"></script>
      <footer class="site-footer">
        <p>&copy; 2025 Ninvax</p>
      </footer>
    <div id="toast" class="toast"></div>
  </body>
</html>
